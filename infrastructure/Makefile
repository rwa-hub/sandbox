# =============================================================================
# RWA Hub infrastructure Makefile
# =============================================================================
# Autor: RWA Hub Team
# Data: 2024
# DescriÃ§Ã£o: Makefile para gerenciamento da infraestrutura do projeto RWA Hub
# =============================================================================

# =============================================================================
# 1. CONFIGURAÃ‡Ã•ES DE CORES E FORMATAÃ‡ÃƒO
# =============================================================================
BOLD := \033[1m
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
MAGENTA := \033[35m
CYAN := \033[36m
RESET := \033[0m

# =============================================================================
# 2. VARIÃVEIS DE AMBIENTE E CAMINHOS
# =============================================================================
# --- 2.1 Caminhos dos pacotes Node.js ---
TREX_PATH := ../packages/blockchain/smart-contracts/lib/T-REX
MARKETPLACE_PATH := ../packages/web/marketplace
PANEL_ADMIN_PATH := ../packages/web/pannel-admin
PACKAGES := $(TREX_PATH) $(MARKETPLACE_PATH) $(PANEL_ADMIN_PATH)

# --- 2.2 ConfiguraÃ§Ãµes Docker ---
DOCKER_COMPOSE := docker-compose -f docker-compose.yml
DOCKER_COMPOSE_INFRA := $(DOCKER_COMPOSE) -f db/docker-compose.yml -f rabbitMQ/docker-compose.yml

# --- 2.3 Ferramentas ---
NPM := npm

# =============================================================================
# 3. MENSAGENS DO SISTEMA
# =============================================================================
# --- 3.1 Mensagens de Infraestrutura ---
INFRA_UP_MSG := "ğŸš€ Iniciando infraestrutura completa..."
INFRA_DOWN_MSG := "ğŸ”½ Parando toda infraestrutura..."
INFRA_BUILD_MSG := "ğŸ—ï¸  Construindo imagens Docker..."
INFRA_LOGS_MSG := "ğŸ“‹ Exibindo logs dos containers..."
INFRA_STATUS_MSG := "ğŸ“Š Status dos serviÃ§os..."
INFRA_CLEAN_MSG := "ğŸ§¹ Limpando volumes e containers..."
INFRA_PRUNE_MSG := "ğŸ—‘ï¸  Removendo recursos nÃ£o utilizados..."

# --- 3.2 Mensagens de Rede ---
NETWORK_CREATE_MSG := "ğŸŒ Criando rede rwa-hub-network..."
NETWORK_REMOVE_MSG := "ğŸŒ Removendo rede rwa-hub-network..."

# --- 3.3 Mensagens de Setup ---
SETUP_ENV_MSG := "ğŸ”§ Configurando arquivos .env..."
SETUP_DEPS_MSG := "ğŸ“¦ Instalando dependÃªncias Node.js..."

# =============================================================================
# 4. DEFINIÃ‡ÃƒO DE TARGETS
# =============================================================================
.PHONY: help infra-up infra-down infra-build infra-logs infra-status infra-clean \
        infra-prune network-create network-remove dev ps logs-monitor \
        logs-mongodb logs-rabbitmq setup-env setup-deps install-deps clean-deps

.DEFAULT_GOAL := help

# =============================================================================
# 5. COMANDOS DE AJUDA
# =============================================================================
help:
	@echo "$(BOLD)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(BOLD)â•‘                   RWA Hub infrastructure                   â•‘$(RESET)"
	@echo "$(BOLD)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(BOLD)â–¶ COMANDOS PRINCIPAIS$(RESET)"
	@echo "  $(CYAN)make setup-env$(RESET)       â†’ Configura arquivos .env iniciais"
	@echo "  $(CYAN)make setup-deps$(RESET)      â†’ Configura todas as dependÃªncias Node.js"
	@echo "  $(CYAN)make dev$(RESET)             â†’ Inicia ambiente de desenvolvimento completo"
	@echo "  $(CYAN)make infra-up$(RESET)        â†’ Inicia todos os serviÃ§os"
	@echo "  $(CYAN)make infra-down$(RESET)      â†’ Para todos os serviÃ§os"
	@echo ""
	@echo "$(BOLD)â–¶ GERENCIAMENTO DE DEPENDÃŠNCIAS$(RESET)"
	@echo "  $(MAGENTA)make install-deps$(RESET)   â†’ Instala dependÃªncias de todos os pacotes"
	@echo "  $(MAGENTA)make clean-deps$(RESET)     â†’ Remove node_modules de todos os pacotes"
	@echo ""
	@echo "$(BOLD)â–¶ MONITORAMENTO$(RESET)"
	@echo "  $(YELLOW)make infra-logs$(RESET)      â†’ Exibe logs de todos os serviÃ§os"
	@echo "  $(YELLOW)make logs-monitor$(RESET)    â†’ Logs do serviÃ§o monitor"
	@echo "  $(YELLOW)make logs-mongodb$(RESET)    â†’ Logs do MongoDB"
	@echo "  $(YELLOW)make logs-rabbitmq$(RESET)   â†’ Logs do RabbitMQ"
	@echo ""
	@echo "$(BOLD)â–¶ MANUTENÃ‡ÃƒO$(RESET)"
	@echo "  $(RED)make infra-clean$(RESET)     â†’ Remove containers e volumes"
	@echo "  $(RED)make infra-prune$(RESET)     â†’ Limpa recursos nÃ£o utilizados"
	@echo "  $(RED)make infra-restart$(RESET)   â†’ Reinicia todos os serviÃ§os"
	@echo ""
	@echo "$(BOLD)â–¶ REDE$(RESET)"
	@echo "  $(BLUE)make network-create$(RESET)  â†’ Cria rede Docker"
	@echo "  $(BLUE)make network-remove$(RESET)  â†’ Remove rede Docker"
	@echo ""
	@echo "$(BOLD)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(BOLD)â•‘                    DocumentaÃ§Ã£o Completa                    â•‘$(RESET)"
	@echo "$(BOLD)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"

# =============================================================================
# 6. COMANDOS DE DEPENDÃŠNCIAS
# =============================================================================
setup-deps: install-deps
	@echo "$(GREEN)âœ“ Todas as dependÃªncias foram instaladas com sucesso!$(RESET)"

install-deps:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(CYAN)â•‘      Instalando DependÃªncias...        â•‘$(RESET)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@for dir in $(PACKAGES); do \
		echo "$(CYAN)ğŸ“¦ Instalando em $$dir...$(RESET)"; \
		cd $$dir && $(NPM) install && cd - > /dev/null; \
		echo "$(GREEN)âœ“ $$dir instalado com sucesso!$(RESET)"; \
	done

clean-deps:
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(YELLOW)â•‘      Removendo node_modules...         â•‘$(RESET)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@for dir in $(PACKAGES); do \
		echo "$(YELLOW)ğŸ§¹ Limpando $$dir...$(RESET)"; \
		rm -rf $$dir/node_modules; \
		echo "$(GREEN)âœ“ $$dir limpo com sucesso!$(RESET)"; \
	done
	@echo "$(GREEN)âœ“ Todas as dependÃªncias foram removidas!$(RESET)"

# =============================================================================
# 7. COMANDOS DE INFRAESTRUTURA
# =============================================================================
infra-up: network-create
	@echo "$(CYAN)$(INFRA_UP_MSG)$(RESET)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ“ Infraestrutura iniciada com sucesso!$(RESET)"
	@make ps

infra-down:
	@echo "$(YELLOW)$(INFRA_DOWN_MSG)$(RESET)"
	@$(DOCKER_COMPOSE) down
	@echo "$(GREEN)âœ“ Infraestrutura parada com sucesso!$(RESET)"

infra-build:
	@echo "$(CYAN)$(INFRA_BUILD_MSG)$(RESET)"
	@$(DOCKER_COMPOSE) build
	@echo "$(GREEN)âœ“ Build concluÃ­do com sucesso!$(RESET)"

# =============================================================================
# 8. COMANDOS DE MONITORAMENTO
# =============================================================================
infra-logs:
	@echo "$(CYAN)$(INFRA_LOGS_MSG)$(RESET)"
	@$(DOCKER_COMPOSE) logs -f

logs-monitor:
	@echo "$(CYAN)ğŸ“‹ Logs do Monitor:$(RESET)"
	@$(DOCKER_COMPOSE) logs -f rwa-blockchain-indexer

logs-mongodb:
	@echo "$(CYAN)ğŸ“‹ Logs do MongoDB:$(RESET)"
	@$(DOCKER_COMPOSE) logs -f rwa-mongodb

logs-rabbitmq:
	@echo "$(CYAN)ğŸ“‹ Logs do RabbitMQ:$(RESET)"
	@$(DOCKER_COMPOSE) logs -f rwa-rabbitmq

# =============================================================================
# 9. COMANDOS DE REDE
# =============================================================================
network-create:
	@echo "$(CYAN)$(NETWORK_CREATE_MSG)$(RESET)"
	@docker network rm rwa-hub-network 2>/dev/null || true
	@docker network create --driver bridge \
		--attachable \
		--label com.docker.compose.network=rwa-hub-network \
		--label com.docker.compose.project=rwa-hub \
		rwa-hub-network 2>/dev/null || true
	@echo "$(GREEN)âœ“ Rede criada ou jÃ¡ existente!$(RESET)"

network-remove:
	@echo "$(YELLOW)$(NETWORK_REMOVE_MSG)$(RESET)"
	@docker network rm rwa-hub-network 2>/dev/null || true
	@echo "$(GREEN)âœ“ Rede removida!$(RESET)"

network-restart: network-remove network-create
	@echo "$(GREEN)âœ“ Rede reiniciada com sucesso!$(RESET)"

# =============================================================================
# 10. COMANDOS DE DESENVOLVIMENTO
# =============================================================================
dev: setup-env setup-deps network-restart infra-build infra-up
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(GREEN)â•‘   Ambiente de Desenvolvimento Pronto   â•‘$(RESET)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(CYAN)ğŸ“ Use 'make infra-logs' para ver os logs$(RESET)"
	@echo "$(CYAN)ğŸ“Š Use 'make infra-status' para ver o status$(RESET)"
	@echo ""
	@make ps

# =============================================================================
# 11. COMANDOS DE MANUTENÃ‡ÃƒO
# =============================================================================
infra-clean:
	@echo "$(YELLOW)$(INFRA_CLEAN_MSG)$(RESET)"
	@$(DOCKER_COMPOSE) down -v
	@echo "$(GREEN)âœ“ Limpeza concluÃ­da!$(RESET)"

infra-prune:
	@echo "$(YELLOW)$(INFRA_PRUNE_MSG)$(RESET)"
	@docker system prune -f
	@docker volume prune -f
	@echo "$(GREEN)âœ“ Limpeza de recursos concluÃ­da!$(RESET)"

infra-restart: infra-down infra-up
	@echo "$(GREEN)âœ“ ServiÃ§os reiniciados com sucesso!$(RESET)" 